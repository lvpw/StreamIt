<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="StreamIt" default="build" basedir=".">
  <description>
    ANT build file for the StreamIt compiler and library.
  </description>

  <!-- PROPERTIES.  These are mostly implicitly used by other rules,
       but it's legitimate to refer to them inside most strings
       using e.g. "${build.compiler}". -->
  <property name="build.compiler" value="jikes"/>
  <property name="build.compiler.emacs" value="true"/>
  <property name="build.compiler.fulldepend" value="true"/>

  <!-- FRONT-END.  This has two interdependent ANTLR targets,
       plus some standalone Java code.  The Java code is built by
       the main compiler rule. -->
  <target name="frontend-lex">
    <antlr target="compiler/streamit/frontend/StreamItLex.g"/>
  </target>
  <target name="frontend-parser-fe" depends="frontend-lex">
    <antlr target="compiler/streamit/frontend/StreamItParserFE.g"/>
  </target>
  <!-- This seems to mostly exist to support the crufty PrintAST
       pass. -->
  <target name="frontend-parser" depends="frontend-lex">
    <antlr target="compiler/streamit/frontend/StreamItParser.g"/>
  </target>
  <target name="frontend-source"
    depends="frontend-parser-fe,frontend-parser" />
  <target name="frontend-clean">
    <!-- In addition to the class files, we need to delete the Java
         and auxiliary files generated by ANTLR. -->
    <delete quiet="true">
      <fileset dir="compiler/streamit/frontend">
	<include name="StreamItLex.java" />
	<include name="StreamItLexTokenTypes.java" />
	<include name="StreamItLexTokenTypes.txt" />
	<include name="StreamItParser.java" />
	<include name="StreamItParserTokenTypes.java" />
	<include name="StreamItParserTokenTypes.txt" />
	<include name="StreamItParserFE.java" />
	<include name="StreamItParserFETokenTypes.java" />
	<include name="StreamItParserFETokenTypes.txt" />
      </fileset>
    </delete>
  </target>

  <!-- KOPI.  Kopi has a couple of strange dependencies, including a
       modified version of ANTLR.  We want to rebuild a subset of
       the files, though not necessarily all of them. -->
  <target name="kjc-tools">
    <!-- There are some internal dependencies within the KJC compiler
         tools; for example, optgen's source depends on both itself
         and the Kopi ANTLR.  Don't worry about these dependencies,
         though, since it's somewhat unlikely we'll be modifying these
         (particularly in the long term). -->
    <javac debug="true" depend="true" nowarn="true">
      <src path="compiler"/>
      <include name="at/dms/compiler/tools/**/*.java"/>
    </javac>
  </target>
  <target name="kjc-options" depends="kjc-tools">
    <java classname="at.dms.compiler.tools.optgen.Main" fork="yes"
      dir="compiler/at/dms/kjc">
      <arg value="KjcOptions.opt"/>
    </java>
  </target>
  <target name="kjc-messages" depends="kjc-tools">
    <!-- Not actually used, though we could in principle depend on
         this as part of kjc-source. -->
    <java classname="at.dms.compiler.tools.msggen.Main" fork="yes"
      dir="compiler/at/dms/kjc">
      <arg value="KjcMessages.msg"/>
    </java>
  </target>
  <target name="kjc-source" depends="kjc-options"/>
  <target name="kopi-clean">
    <delete quiet="true">
      <fileset dir="compiler/at/dms/kjc">
	<include name="KjcOptions.java" />
      </fileset>
    </delete>
  </target>

  <!-- JAVA COMPILATION. -->
  <target name="all-java-source" depends="frontend-source,kjc-source"/>
  <target name="compiler" depends="all-java-source"
    description="Build the StreamIt compiler and front-end">
    <javac debug="true" depend="true" nowarn="true">
      <src path="compiler"/>
      <src path="library/java"/>
      <exclude name="streamit/stair/**"/>
      <exclude name="at/dms/kjc/raw2/**"/>
      <exclude name="streamit/iriter/**"/>
    </javac>
  </target>
  <target name="class-clean">
    <delete>
      <fileset dir="." includes="**/*.class"/>
    </delete>
  </target>

  <!-- LEGACY.  Things left over from the old system: -->
  <target name="cruft-clean">
    <delete>
      <fileset dir=".">
	<include name="**/*.u" />
	<include name="**/*.java.deps" />
      </fileset>
    </delete>
  </target>
  
  <!-- TOP-LEVEL RULES. -->
  <target name="build" depends="compiler"
    description="Build the StreamIt compiler, front-end, and libraries"/>
  <target name="clean"
    depends="class-clean,frontend-clean,cruft-clean,kopi-clean"
    description="Remove all Java class files"/>
</project>

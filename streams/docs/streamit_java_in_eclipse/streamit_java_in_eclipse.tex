%% latex streamit_java_in_eclipse && dvips streamit_java_in_eclipse -o && ps2pdf streamit_java_in_eclipse.ps streamit_java_in_eclipse.pdf
%%
%% images captured with 
%% xwd -nobdrs | xwdtopnm | pnmtopng > foo.png
%% all those intermediate stages because xv (which I often use)
%% gets colormaps wrong on raw, pnm.
%%
%% then changed to encapsulated postscript2 with the gimp.

\documentclass[11pt]{article} 
\usepackage{latex8}
\usepackage{times}
\usepackage{epsfig}
\usepackage{fullpage}
\usepackage{url}
\usepackage{times}
\pagestyle{empty}
%\setlength{\textheight}{10in}
\setlength{\parindent}{0ex}
\setlength{\parskip}{1em}
\raggedbottom			%needed with fixed length \parskip

\begin{document}
\title{Using Eclipse for StreamIt Development in CAG\\DRAFT}
\author{Allyn Dimock, Michael Karczmarek, Rodric Rabbah, Bill Thies}
\maketitle

\section{StreamIt Under Eclipse}
The goal of this exercise is to 
\begin{enumerate}
\item allow .java files in the StreamIt compiler to be edited under
  Eclipse,
\item allow the StreamIt compiler to be debugged under Eclipse,
\item have StreamIt live where it usually 
does so that no changes have to be made to startup files to point to
\$STREAMIT\_HOME,
\item Allow Eclipse to use CVS on StreamIt files.
\end{enumerate}
Caveat: This sets up the entire {\tt streams} directory as a Java project.
We will want to eventually refine this procedure so that we can set up
{\tt streams/src/streamit/eclipse} as a Plugins project, {\tt streams/apps} as a
StreamIt project, and {\tt streams/library/C} and {\tt /cluster} as C projects.

Eclipse currently runs on RHEL3 machines, not on RH7.2 machines.

I alias {\tt eclipse} to 
{\tt /home/bits7/NOBACKUP/eclipse.3.2/eclipse -data \$HOME/workspace}
Note that you can not just link to the eclipse executable from
somewhere in your path since Eclipse needs to know its real path to
work correctly.

The {\tt  -data \$HOME/workspace} tells eclipse to look for my preferences 
files in my {\tt workspace} rather than trying the last workspace that
anyone used.

Without {\tt  -data \$HOME/workspace} you may see a window popping up:

\hspace*\fill\fbox{%
\epsfig{figure=WorkspaceInUse1.eps,width=4in}
} \hspace*\fill

\vspace{+33pt}
In this case you can click and type in the complete path to your
workspace:\footnote{%
If you get the ``Workspace in use'' popup window at some point, and
you have your {\tt -data} switch pointed to the correct workspace,
it is likely that previously exited eclipse with
SIGNAL 9 ({\tt kill -9}) so the workspace remained locked, you
can start Eclipse with 
{\tt -vmargs -Dosgi.locking=none -data \$HOME/workspace} to ignore the
lock.

\url{https://bugs.eclipse.org/bugs/show_bug.cgi?id=44735\#c51}
indicates that this window can pop up if your home directory is served
over nfs and the serving system is running {\tt lockd} but not {\tt statd}. 
They suggest a fix that might make sense to a Linux guru.
We run {\tt statd}. We have not run into that case.
}

%% \hspace*\fill\fbox{%
%% \epsfig{figure=WorkspaceInUse2.eps,height=2.5in}
%% } \hspace*\fill




\section{Checking Out to let Eclipse use CVS}
\label{secCheckout}

First: we need to check out a copy of the {\tt streams} directory in a
form that Eclipse can use.
Eclipse has a CVS client but no CVS server, so we can not do a local
CVS checkout and expect Eclipse to handle CVS.

We need to set up environment variable {\tt CVS\_RSH} to be {\tt ssh}.

We need to checkout as\\
\verb+cvs -d ':ext:USERNAME@SYSTEMNAME:/projects/raw/cvsroot' co streams+\\
Fill in your user name for {\tt USERNAME}.  
Fill in a system name for {\tt SYSTEMNAME}, (e.g. {\tt cagfarm-50}) -- don't use {\tt  localhost}
as a system name if you are going to be developing on multiple systems
sharing a common {\tt streams} directory: If you do this you will get lots
of warnings from {\tt ssh} as you move between systems.

If you can set up your {\tt .ssh/config} to use RSAAuthentication of
something other than interactive authentication with your password,
you will be happier:  Otherwise Eclipse, when using CVS, will require
you to enter your password from the window from which Eclipse was
started. (Assuming that you don't have Eclipse store your
  password, which may be insecure; and assuming that you don't find
  some way to get Eclipse to pop up a password prompt.  There should
  be a way of getting Eclipse to pop up a password prompt, but I don't
know it.)

\section{Setting up a streams project in Eclipse}

If you have never used StreamIt before you should include support for
it in your shell initialization file (.cshrc, .bachrc, whatever...).
Set up the following lines for csh variants:
\begin{verbatim}
setenv STREAMIT_HOME ${HOME}/streams
source $STREAMIT_HOME/include/dot-cshrc
\end{verbatim}
or the following linse for sh variants
\begin{verbatim}
export STREAMIT_HOME=$HOME/streams
. $STREAMIT_HOME/include/dot-bashrc
\end{verbatim}
Also, type these lines at the command level before proceeding.

Now:
\begin{verbatim}
cd ~/streams
make
\end{verbatim}
This builds at least one file that will be essential later: KjcOptions.java,
as well as the libraries used for the uniprocessor and cluster
backends.

Run Eclipse.

If this is your first time running eclipse, you should see a window
that looks like:

\hspace*\fill\fbox{%
\epsfig{figure=Workspace0.eps,height=3in}
} \hspace*\fill

Just click the curved-arrow icon at the right to get going.

From {\tt File $\rightarrow$ New $\rightarrow$ Project}
(or the context menu from right-clicking in the {\tt Package Explorer}
panel\footnote{%
Eclipse documentation calls subdivisions of the main window
``views''.  We will use that term henceforth.})
create a new Java project.
%\footnote{I know how to add CVS to a Java project
%but not Java features to a CVS project.}
Eclipse should pop up a window like that in %Figure~\ref{javapOne}.
the illustration below.
If, for some reason, ``Java Project'' is not highlighted, click on it.
Then click on ``Next''.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=new_project1.eps,height=4in}
} \hspace*\fill
%\caption{{\protect\small Creating a Java Project: Panel 1.}}
%\label{javapOne}
%\end{figure}

If you set the radio button for ``Create separate source and output
folders'' eclipse will create a {\tt outut} directory under your {\tt
 streams} directory with subdirectories mirroring your source tree 
and will create all {\tt .class} files in the {\tt output}
directory tree.  If you do set that radio button then the {\tt .class}
files are created in the directory containing the {\tt .java} file. 

When you click Next, you will get a window like %Figure~\ref{javapTwo}.
the one below.
Fill in the project name, select ``Create project from existing
source'', give the full path to your {\tt streams} directory, and
click on ``Next'' (if available: eclipse 3.1 allowed ``Next'',
eclipse 3.2 only allowed ``Finish'').

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=new_project2.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: panel 2}
%\label{javapTwo}
%\end{figure}


Clicking ``Next'' should allow you to configure how the project is
built under Java: it should pop up a window similar to the one in
%Figure~\ref{javapSix}.
the illustration below:

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=new_project6.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: Excluding from Build Path}
%\label{javapSix}
%\end{figure}

Do not worry about the number of errors listed on ``Problems'' view:
The number of errors should drop to 0 once you exclude the souce
folders and include the jar files as recommended below.

If you clicked on ``Finish'' rather than ``Next'', you can 
change Java build properties on a Java project after the
project is set up: select the root of the project, right click, select
``Properties''  from the context menu, and select ``Java Build Path''
from the menu at the left of the window.  
%Figure~\ref{javapThree} was generated this way.
The illustration below was generated this way.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=new_project3.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: Panel 3}
%\label{javapThree}
%\end{figure}

Select the ``Source'' tab and remove the following from the Java build
Path by clicking on ``Remove from Java build path''
\begin{itemize}
\item All {\tt streams/docs} and any subdirectories that appear in the listing:
 We don't want to try to build any example Java code.
\item {\tt streams/src/streamit/eclipse} contains some .java files for the
eclipse StreamIt plugin.
We don't want to try to build these. 
\item {\tt streams/regtest/streamit} (The JUnit-based regression test
  package) has been superseded by the {\tt streams/regtest/qmtest}
  regression test package.  Remove it from the build path.
\item {\tt streams/src/com},\\
 {\tt streams/src/org},\\ 
 {\tt streams/src/streamit/stair}\\
 and any subdirectories that appear in the listing:
 These are not necessary for building the StreamIt compiler and may contain
 errors that would persistently appear in Eclipse's ``Problems'' view
 if not removed. 
\item The following application directories contain Java code that
  produces error messages. Remove the following for now, or just remove all of
  the {\tt apps} subdirectory:\\
  {\tt streams/apps/applications/nolia/streamit},\\
  {\tt streams/apps/applications/nolia-fine},\\
  {\tt  streams/apps/applications/nolia-new},\\ 
  {\tt raytracer/library},\\
  {\tt reed-solomon},\\
  {\tt streams/apps/benchmarks/nokia/streamit},\\
  {\tt streams/apps/benchmarks/viram/fft},\\
  {\tt streams/apps/examples/hello},\\
  {\tt streams/apps/examples/median},\\
  {\tt streams/apps/examples/sample-trellis},\\
  {\tt streams/apps/examples/toy-trellis},\\
  {\tt streams/apps/examples/old/*},\\
  {\tt streams/apps/tests/field-init},\\
  {\tt streams/apps/tests/fir-test},\\
  {\tt streams/apps/tests/flybit},\\
  {\tt streams/apps/tests/fuse-test},\\
  {\tt streams/apps/tests/hello-message},\\
  {\tt streams/apps/tests/hello-simple},\\
  {\tt streams/apps/tests/hello-splits},\\
  {\tt streams/apps/tests/lineartest/regtests},\\
  {\tt streams/apps/tests/weighted-rr}.
\end{itemize}
(List may be out of date as new StreamIt applications are written.)

Directories removed from the build path may be reinstated later...

You can copy and paste from the source of this document to reduce
your typing.
%
Another method of excluding directories (after clicking ``Finish'' in
setting up the project) is to highlight the {\tt streams} project in
the Package Explorer,\footnote{%
If there is no ``Package Explorer'' view, then 
``Window $\rightarrow$  Show View $\rightarrow$ Package Explorer''
}
then 
``Project $\rightarrow$ Properties $\rightarrow$ Java Build Path''
Click the ``Source'' tab if not already selected.
Expand the directory if necessary to find a line starting with ``Excluded:''
Click on the ``Excluded:'' line to highlight it.

I have not re-installed to check if there is a similar way of
excluding from the ``Java project'' wizard.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=exclude-1.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: Excluding from Build Path later}
%\label{javaxOne}
%\end{figure}

Click on ``Edit...'' to bring up a window of inclusion and exclusion
patterns, put in the necessary exclusion patterns, and then click
``OK''.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=exclude-2.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: Excluding from Build Path later}
%\label{javaxTwo}
%\end{figure}



We need to set up the class path for the project.\footnote{%
Unfortunately,
there seems to be only one class path per project, and our directory
structure is not such that we can easily break {\tt streams} down into
sub-projects.}

Click the ``Libraries'' tab.\\
You will need to ``Add External JARs...'' for our antlr implementation
({\tt /usr/uns/java/antlr.jar}).\footnote{
  There is an antlr plug-in for eclipse available from
  \url{http://antlreclipse.sourceforge.net}
  The antlr plug-in allows sensible editing and building of ``.g''
  files.
  Installation directions are on the web page.
  I have included the plugin in the eclipse plugins directory, but
  have not had to edit any {\tt .g} files yet, nor have I used its {\tt .jar} file
  in place of StreamIt's {\tt antlr.jar} 
}

You will need to ``Add JARs...'' for {\tt streams/3rdparty/cplex/cplex.jar},\\
{\tt streams/3rdparty/JFlex/jflex.jar}, {\tt streams/3rdparty/jgraph/jgraph.jar},\\
and {\tt streams/3rdparty/jcc/jcc.jar}\footnote{%
If you wish to play with the obsolete streams/regtest/streamit code,
you will also need to ``Add JARs...'' for 
{\tt streams/regtest/streamittest/junit.jar}.
Eclipse has a Junit
interface. I do not know whether including
{\tt streams/regtest/streamittest/junit.jar} will interfere with that
interface or not.
}
%, and (if you do not exclude
%streams/regtest/streamit from your build path)
%streams/regtest/streamittest/junit.jar\footnote{Eclipse has a Junit
%  interface. I do not know whether including
%  streams/regtest/streamittest/junit.jar will interfere with that
%  interface or not.}
%
%See Figure~\ref{javapFive}.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=new_project5.eps,height=4in}
} \hspace*\fill
%\caption{Creating a Java Project: JAR browser}
%\label{javapFive}
%\end{figure}

(Figure is out of date: should also add {\tt 3rdparty/jflex.jar})

Even though the standard CLASSPATH includes streams/3rdparty and
streams/src, you {\em do not need to} ``Add Class Folder'' for these to get
the StreamIt compiler to build, which is lucky since Eclipse will not
allow you to use ``Add Class Folder'' for a subdirectory of the
current project.\footnote{%
The lack of these directories in the project class path may be the
cause of some of the errors that forced us to exclude some
applications from the build path.
If this is the case, the only solution I can see would be to check out the
applications into their own project.}

\bigskip

%% To build the StreamIt compiler as currently implemented, we need to
%% change some settings in Eclipse's Java compiler.
%% Follow ``Window $\rightarrow$ Preferences'' to set compiler
%% preferences.  Uncheck the ``Use default compliance settings'' box and
%% set settings as 
%% below.  
%% %in Figure~\ref{compilerPrefs}
%% Click ``Apply'' to make the changes.

%% %\begin{figure}[htb]
%% \hspace*\fill\fbox{%
%% \epsfig{figure=compiler-preferences.eps,height=4in}
%% } \hspace*\fill
%% %\caption{Setting Compiler Preferences}
%% %\label{compilerPrefs}
%% %\end{figure}


Change some settings for how the Eclipse editors handle text,
just to be safe (To use US-ASCII encoding and Unix line terminators):
``Window $\rightarrow$ Preferences... $\triangleright$ General
$\rightarrow$ Info''

\hspace*\fill\fbox{%
\epsfig{figure=text-prefs.eps,height=4in}
} \hspace*\fill

Fix indentation so that eclipse users and emacs users do not constantly have 
to reformat each other's code:
``Window $\rightarrow$ Preferences... $\triangleright$ Java $\triangleright$
Code Style $\rightarrow$ Formatter''

Create a new template based on the default template, and set ``Tab
policy'' to be ``Spaces only'' from the drop-down menu.  ``Indentation
size'' should be ``4'' for StreamIt code.  Set the ``Tab size'' to be
8.  With these settings eclipse will correctly read files created by
emacs, which use tab stops every 8 characters (the default behavior of
emacs).  Eclipse will perform all its indentation using spaces, which
should be readable by any editor.

\hspace*\fill\fbox{%
\epsfig{figure=formatter_preferences1.eps,height=4in}
} \hspace*\fill

\hspace*\fill\fbox{%
\epsfig{figure=formatter_preferences2.eps,height=4in}
} \hspace*\fill

Select your new profile, Press ``Apply'' and then ``OK''.
\bigskip

Back to getting the streams directory set up as an eclipse project...

Creat a ``Problems'' view by 
``Window $\rightarrow$ Show View $\rightarrow$ Problems'' if there is
not one already on the screen.

Now click on the Filters icon
(\epsfig{figure=filters1.eps,height=2ex}) on the ``Problems'' view
and set to only display errors. 
%See Figure~\ref{problemFilters}.  
Compiling the StreamIt
compiler generates several thousand warnings which will otherwise be
displayed in the ``Problems'' view.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=problem_filters.eps,height=4in}
} \hspace*\fill
%\caption{Setting Filters for Problems}
%\label{problemFilters}
%\end{figure}

Setting  ``Where severity is'' and ``Error'', will filter out warning
messages that would otherwise show up in the ``Problems'' view.\footnote{%
for eclipse 3.2, the warnings should just vanish from the ``Problems''
view except for a count of filtered warnings in the header line.

For eclipse 3.1, you need to perform a rebuild to get rid of the
warning messages.
 
Click on the {\tt streams} project to highlight it in the
``Package Explorer'' view.

Select menu item ``Project $\rightarrow$ Build Automatically'' to
remove the check mark next to ``Build Automatically'' if one is there.
(If one was not there and you just created one then repeat to remove
the check mark.)

Now, menu item ``Project $\rightarrow$ Build Project'' should not be
grayed-out, so select it to build the project.
After some time,
you should see 0 errors, but lots or warnings in the information line
at the top of the ``Problems'' view.

Click ``Project $\rightarrow$ Build Automatically'' again, so that the
menu item is checked. This will cause partial rebuilds to happen
automatically when a file is saved.
}


%% No longer needed in eclipse 3.2: detects CVS directories gets
%% correct CVS parameters for project.
%% \section{Accessing CVS through Eclipse}
%%
%% To set up so that Eclipse can use CVS, you need to have checked out
%% from CVS as prescribed in Section~\ref{secCheckout}.
%%
%% \begin{itemize}
%% \item Click on the ``streams'' project to select it.
%% \item Right-click to get the context menu for the project.
%% \item Select ``Team $\rightarrow$ Share Project''
%% \item In the pop-up window ``Connect Project to Repository'' click on
%%   ``Finish''.
%% \end{itemize}

\section{Running the StreamIt Compiler in Eclipse}

Todo: bring up to date for eclipse 3.2, and for new selection of back ends.

The {\tt strc} compiler script will not run with the current setup:
someone will have to update the StreamIt plugins to work with Eclipse 3.1
But, we can run the java compiler on programs that {\tt strc} has
converted from {\tt str} format to {\tt java}.

To compile a file with the StreamIt compiler, you need to set up a
``run configuration'', which be done by following ``Run $\rightarrow$ Run...''
or ``Run $\rightarrow$ Debug...''.
%Figure~\ref{runOne} 
The illustration below
shows setting up a new configuration for running
Java applications.
You may want one configuration per set of commonly-used StreamIt
compiler switches.

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=run-debug1.eps,height=4in}
} \hspace*\fill
%\caption{Setting up a run configuration: Panel 1}
%\label{runOne}
%\end{figure}


Set up the arguments for your run / debug configuration.
The illustration below shows setting up the arguments for a run:\\
the ``VM arguments'' are those usually created by strc.\\
The ``Program arguments'' are ``--streamit'' which is always the first
argument, then the arguments for running on a cluster, with a pop-up
menu asking for the ``Number of Processors'' and defaulting to 1, and
with a file selection dialog for ``Pre-compiled file, .java assumed''
with input pre-set to the {\tt apps} subdirectory of the project
directory which hopefully will decrease the number of characters you
have to type to get to the file that you want to compile.
%
%Figure~\ref{runTwo} shows setting up the arguments for a run.
%instead of using \verb+${file_prompt+, which gives you a text entry and a 
%file browser, you could use other built-in
%variables such as \verb+${string_prompt}+, which gives you test entry only.
Click the ``Variables'' button to see a list of other potentially
useful variables to use in prompts.\footnote{%
After using this for a while, I decided that we should not set up the
options to append ``.java'':  The file selection box gives you the
full filename when used in point-and-click mode.  I seem to use it
more often in point-and-click mode than I do with just typing in
paths to files. I just haen't gotten around to updating the figure yet. 
}

%\begin{figure}[htb]
\hspace*\fill\fbox{%
\epsfig{figure=run-debug2.eps,height=4in}
} \hspace*\fill
%\caption{Setting up a run configuration: Panel 2}
%\label{runTwo}
%\end{figure}

The contents of the ``JRE'', ``Classpath'', ``Source'',
``Environment'', and ``Common'' tabs all seem to be OK. without
modification.\\ 
Once you are through setting up configurations, click ``Apply''.\\
(The fancy defaults turn out not to be too useful: Eclipse tries to be
helpful by reusing the last value of a \$\{whatever\} variable.)

Once the program has been run, you can re-run it by selecting 
``Run $\rightarrow$ Run last launched'' (Ctrl+F11). 

You will need a pre-compiler to convert .str files to .java files as
shown in the next two illustrations.

\hspace*\fill\fbox{%
\epsfig{figure=run-debug3.eps,height=4in}
} \hspace*\fill

\hspace*\fill\fbox{%
\epsfig{figure=run-debug4.eps,height=4in}
} \hspace*\fill

\section{Eclipse Gotchas}

Eclipse believes that it has control over its project directories
unless told otherwise: If I want to run the StreamIt preprocessor in a
subdirectory of {\tt apps} and make the resulting .java file visible
in Eclipse then I will need use ``Refresh'' from the context menu for
the directory.

Key bindings are different for different windows!
Shift+Ctrl+L will generally show you the key bindings for a window

Modify keys with ``Window $\rightarrow$ Preferences $\rightarrow$
General $\rightarrow$ Keys''  
For instance: ``Modify'' tab, pull down ``Scheme'', select ``Emacs'' 
This gives some standard Emacs key bindings, but far from the full set.

Is ``src'' a special directory name in Eclipse?
I was not able to make an Eclipse project out of just streams/src: some 
eclipse files ended up in streams instead,  but I didn't try all that hard...
We might want to try to set up src as one project, the applications as
another project and the eclipse plugin for .str files as a third
project.
Given the structure of the streams directories, this might be
difficult.
Especially to separate out the eclipse plugin, which is in
streams/src/streamit/eclipse.

For some reason, Eclipse, as set up above was {\em sometimes} not catching assertion
errors despite the ``-ea'' switch to java from the debug
configuration.  I was able to fix this in the JRE tab of the debug
configuration window by using /home/linux/jdk-1.5.0\_01/jre rather than
/home/linux/j2sdk-1.4.2\_03: Once I added and used /home/linux/jdk-1.5.0\_01/jre, then 
/home/linux/j2sdk-1.4.2\_03 started catching the assertion errors.  I am baffled by this behavior.

Trying to update streams from CVS in Eclipse:
Eclipse follows symbolic links so \url{streams/misc/raw/Makefile.include} and
\url{streams/misc/raw/stardata/starbuild} will cause problems since they point to common files under 
CVS control -- but not in the user's directory tree, and not with CVS/Root in a format that 
Eclipse understands.




\end{document}

%% % Sets box from page width. Not what I want...
%% \begin{boxfigure}{label}{caption}
%% payload
%% \end{boxfigure}

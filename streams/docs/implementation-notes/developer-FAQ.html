<!--
  Copyright 2003 by the Massachusetts Institute of Technology.

  Permission to use, copy, modify, and distribute this
  software and its documentation for any purpose and without
  fee is hereby granted, provided that the above copyright
  notice appear in all copies and that both that copyright
  notice and this permission notice appear in supporting
  documentation, and that the name of M.I.T. not be used in
  advertising or publicity pertaining to distribution of the
  software without specific, written prior permission.
  M.I.T. makes no representations about the suitability of
  this software for any purpose.  It is provided "as is"
  without express or implied warranty.
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>StreamIt Developer FAQ</title>
<!-- TODO: links to sub packages -->
<!-- TODO: iterators: put where? -->
</head>
<body>
<h1>FAQ for developers</h1>
<ul>
<li>How do I generate a unique name?
<p>
We never tried to standardize this until too late.
Here are some preferred routines:
<ul>
<li> at.dms.kjc.sir.lowering.RenameAll.newName("xxx") generates "xxx__NNN"
<li> at.dms.kjc.sir.lowering.LoweringConstants.getUniqueVarName() generates
"streamItVar_NNN"
<li> at.dms.kjc.sir.lowering.ThreeAddressCode.nextTemp() generates
"__tmpNNN"
</ul>
<br/>
<li>Where do I find the intermediate representation?
<p>
The compiler works on an abstract syntax tree.
</p><p>
The underlying representation from the Kopi compiler, modified to our needs is found in at/dms/kjc.
</p><p>Extensions for SIR primitives and SIR graphs are found in at.dms.kjc.sir.
</p><p>The Slice Graph representation for unstructured graphs is found in at.dms.kjc.slicegraph.
</p><p>The Flatgraph representation found in at.dms.kjc.flatgraph is deprecated, but is still used transiently for some partitioners, for creating subgraphs with only static rates (if there are dynamic rate edges in the SIR graph), and is used extensively in the at.dms.kjc.spacedynamic back end, and is used in combination with other representations in the at.dms.kjc.cluster back end.
</p><p>The LIR extensions in at.dms.kjc.lir, and the code in library/c are for the initial implementation fo the StreamIt compiler (sometimes called the old Uni back-end), and are no longer supported.
</p>
<p>
The library intermediate representation is Java code.
</p>
</li>
<li>How do I iterate over the intermediate representation(s)?

<p>There are iterators for the SIR graph that work both for the library 
({@link streamit.library.iriter}) 
and for the compilers ({@link at.dms.kjc.iterator}).
A standard way of walking the SIR graph is to use 
<code>IterFactory.createFactory().createIter(str)</code>.
The returned object will have methods to determine some properties of
<code>str</code> in a way that is independent of whether this code is
being run in the library or in the compilers.
One important thing that the returned object will do is to implement
an <code>accept</code> method that will accept a class implementing the
<code>at.dms.kjc.StreamVisitor</code> interface and will iterate
throught the SIR graph (even though the 
<code>at.dms.kjc.StreamVisitor</code> itself performs no 
iteration).  The usual impleemntation of
<code>at.dms.kjc.StreamVisitor</code> is 
<code>at.dms.kjc.EmptyStreamVisitor</code>.
</p>

<p>
Most iteration over the contents of SIRFilters is done using
implementations of the "visitor pattern".

<pre>
class Foo implements SLIRReplacingVisitor {
 ...
   private void foo(SIRStream str) {
       final SLIRReplacingVisitor visitor = this;
       IterFactory.createFactory().createIter(str).accept(
           new EmptyStreamVisitor() {
               public void visitFilter(SIRFilter self,
                                       SIRFilterIter iter) {
                   for (int i = 0; i < self.getMethods().length; i++) {
                       self.getMethods()[i].accept(visitor);
                   }
               }});
   }
 ...
</pre>
<p>In general, you only have to override a few methods of a visitor,
if few enough, can just put inline</p>
<pre>
class Foo {
 ...
   private void foo(SIRStream str) {
       IterFactory.createFactory().createIter(str).accept(
           new EmptyStreamVisitor() {
               public void visitFilter(SIRFilter self,
                                       SIRFilterIter iter) {
                   for (int i = 0; i < self.getMethods().length; i++) {
                       self.getMethods()[i].accept(new SLIRVisitor(){
                       public Object visitFieldExpression(JFieldAccessExpression self,
                            JExpression left, String fieldIdent) {
                            ...
                      } });
                   }
               } });
   }
 ...
</pre>
<p>If you extend a standard visitor to override several methods, then
you should probably implement the specialized visitor as an inner
class in your class.</p>
<p>Some standard visitors:

<table border="1">
<tr>
<th>Visitor</th>
<th>Kjc Visitor</th>
<th>Accepted By</th>
<th>use</th>
</tr>
<tr>
<td>StreamVisitor</td>
<td></td>
<td>Iterator</td>
<td>interface</td>
</tr>
<tr>
<td>EmptyStreamVisitor</td>
<td></td>
<td>(Iterator)</td>
<td>implements StreamVisitor, Iterator uses this to walk SIRStream's</td>
</tr>
<tr>
<td>AttributeStreamVisitor</td>
<td></td>
<td>SIROperator</td>
<td>interface</td>
</tr>
<tr>
<td>EmptyAttributeStreamVisitor</td>
<td></td>
<td>(SIROperator)</td>
<td>recurrs, implements AttributeStreamVisitor</td>
</tr>
<tr>
<td>ReplacingStreamVisitor</td>
<td></td>
<td>(SIROperator)</td>
<td>recurrs, replaces substreams, implements AttributeStreamVisitor</td>
</tr>
<tr>
<td>SLIRAttributeVisitor</td>
<td>AttributeVisitor</td>
<td>JPhylum</td>
<td>interface for visitors returning values</td>
</tr>
<tr>
<td>SLIREmptyAttributeVisitor</td>
<td>EmptyAttributeVisitor</td>
<td>(JPhylum)</td>
<td>recurrs, returns passed object</td>
</tr>
<tr>
<td>SLIRReplacingVisitor</td>
<td>ReplacingVisitor</td>
<td>(JPhylum)</td>
<td>extends (SLIR)EmptyAttributeVisitor, replacing changed substructures</td>
</tr>
<tr>
<td>StatementQueueVisitor</td>
<td></td>
<td></td>
<td>Visited expressions in certain places can add statements before
the the next executable statment, for instance visiting the
contitional of an <b>if</b> may cause statements to be added to the
consequent and alternate branches of the if.</td>
</tr>
<tr>
<td>SLIRVisitor</td>
<td>KjcVisitor</td>
<td>JPhylum</td>
<td>Interface for visitors used purely for side effect, not returning
any value,</td>
</tr>
<tr>
<td>SLIREmptyVisitor</td>
<td>KjcEmptyVisitor</td>
<td>(JPhylum)</td>
<td>recurrs, implements {SLIT/Kjc}Visitor</td>
</tr>
<tr>
<td>ExpressionVisitor</td>
<td></td>
<td>JExpression</td>
<td>interface</td>
</tr>
<tr>
<td>ExpressionVisitorBase</td>
<td></td>
<td>(JExpression)</td>
<td>implements ExpressionVisitor, throws UnsupportedOperationException</td>
</tr>
</table>

<p>There is a bit of a mismatch between the SIRStream / SIROperator visitors
and the JPhylum visitors.  There are JExpressions that are part of
SIROperators that do not normally get visited in the examples above.  
<b>StaticsProp.iterOverFieldsAndMethods</b> attempts to remedy this
for situations where it is necessary to visit parameters of
SIRStreams: splitter and joiner weight JExpressions, feedback loop
delay expression, filter method push, pop, peek rate expressions.
Visiting these expressions is generally of interest in the
at.dms.kjc.sir.lowering passes, but parameters are expected to become
constant after these passes.</p>

</li>
<li>How do I add a new back end?
<p>See <a href="adding-a-backend.html">adding-a-backend</a>.</p>
</li>
<li>
How do I find out what the benchmarks and applications do?
<p>Run $STREAMIT_HOME/misc/build-bench-doc<br/>
It will produce a file $STREAMIT_HOME/apps/benchmarks.html containing
documentation from all benchmark.xml files in subdirectories of
$STREAMIT_HOME/apps.
</p>
<p>
This only works if someone has written a description!
We need to enforce that any application developer create a
benchmark.xml file containing a description of the code: what it does,
where the algorithms are documented, whether we have permission to
include it in a release.
</p>
<p>
Some notes that are not included in benchmark.xml files, or where
benchmark.xml is missing:
</p>
<pre>
apps directory:
--------------
crc       CRC32 calculation in c and StreamIt 1.0 (java)
          StreamIt 1.0 no longer supported.
          author D.Maze
 
DCT       presumable discrete cosine transform and inverse,
          relation to benchmarks/dct unknown.
 
FAT       some sort of radar processing?
          "Feature Aided Tracking"??
          http://stinet.dtic.mil/cgi-bin/GetTRDoc?AD=ADA427295&Location=U2&doc=GetTRDoc.pdf
          in StreamIt 1.0,  no longer supported.
 
FAT-new   Streamit 2 adaption of FAT.
          author unknown
          author unknown, check CVS logs...

hdtv      fragments of hdtv encode / decoder.  Which implemented?
          ReedSolomon, Trellis, Ungerboeck
          in StreamIt 1.0,  no longer supported.
          author unknown, check CVS logs...
  
nokia     ??
          possibly part of "Group Radio Access Network" protocols
          /projects/streamit/3rdparty/specs/nokia-3gpp/
          in StreamIt 1.0,  no longer supported.
          author unknown, check CVS logs...
                                                                                
nokia-fine  ?? a few diffs from nokia/streamit code but no more comments.
          in StreamIt 1.0,  no longer supported.
          author unknown, check CVS logs...
 
nokia-new ?? a few diffs from nokia/streamit code but no more comments.
          in StreamIt 1.0,  no longer supported.
          author unknown, check CVS logs...
 
raytracer simple raytracer with hard-coded scene.
           RayTracer_works.java may work but StreamIt 1.0
           have not tried RayTracer.str
 
raytracer-new re-implementation of raytracer.
          library version has some Java extension code, "cluster" version
          has some c++ extension code.
          Janis Sermulins based on example from Intel.
 
reed-solomon implementation of Reed-Solomon encoder, decoder in StreamIt 1.0
          Comments in README say worth converting to StreamIt 2, but no such
          port has been carried out yet.
          author unknown, check CVS logs...
 
 
video     forward motion prediction algorithm
          for what format?
          author unknown, check CVS logs...
 
benchmarks directory:
--------------------
 
asplos06, asplos06-space, asplos06-superset are all selections from the
          benchmarks.  May include some performance gathering scripts.
          exception is that they include channelvocoder, which is different
          from vocoder.  May change parameters or contain only
          portions of benchmark codes.
 
pldi-03   another selection, also contains
          OneBitDToA.str  based on processing for 1-bit d-a in a CD player.
          Oversampler.str portion of OneBitDToA.
          SamplingRateConverter.str multiplt a sample rate with interpolation.
 
raw_isca_04 remains of a deleted collection.
 
traces   yet another collection.  targetdetector presumably extracted from GMTI
         application

cfar       no description in benchmark.xml presumably second stage of GMTI:
 
Constant False Alarm Rate:  calculating a finite series for a sliding window,
divide a value calculated for the center of the window by the appropriate
seties value, and compare ration with some threshold value.
From "Polymorphous Computing Architecture Kernel-Level Benchmarks I"
/projects/streamit/3rdparty/specs/pca-kernel-benchmarks/PCA-Kernel-1.pdf

firbank  no benchmark.xml.
%   Returns the result of applying a bank of FIR filters to the matrix x.
%   The frequency-domain coefficients for each FIR filter are contained
%   in a vector of length n; there are assumed to be m such filters.
%   Each row of the output matrix y(i,:) is the result of filtering
%   x(i,:) with the coefficients in the matrix f(i,:).
(a bunch of frequency-domain FIR filters in parallel...)

h264 no benchmark.xml. "MPEG4" decoder.

mosaic  no benchmark.xml.
  correlate images, extract features, use RANSAC algorithm to suppress
  incorrect matches.
  Basier Asiz
 
 
nokia   no description in benchmark.xml file.
        Andrew, Jasper
 
perftest4 no description in benchmark.xml file.
        portion of a software radio??
</pre>
</li>
<li>
<p>Compiler internal debugging techniques:</p>
<p>A lot of classes have a "debug" or "debugging" flag that can be turned on.<br/>
strc --backendvalues "at.dms.kjc.cluster.ClusterBackend.debug true at.dms.kjc.sir.lowering.ConstantProp.debug true"<br/>
The above only an example those particular flage may not exist.
</p>
<p>Ye goode olde print statement.</p>
<p>at.dms.kjc.sir.SIRToStreamIt  dumps internal representation in source format.</p>
<p>at.dms.util.SIRPrinter dumps internal format with a bit more detail.</p>

<p>Some code for printing an element of a stack trace:</p>
<pre>
   // getting caller or caller's caller...
   private final Throwable tracer = new Throwable();

    private String findCaller() {
        if (debugDepth < 0) {
            throw new IllegalArgumentException();
        }
        tracer.fillInStackTrace();
        return tracer.getStackTrace()[debugDepth + 1].toString();
    }
</pre>
<p>If you can get a StreamIt application to fail in library then can use a java debugger.</p>
</li>
<li><p>Cloning:<br/>
Why and wherefor of cloning...<br/>
at.dms.kjc,CloneGenerator<br/>
remember to add class name to at.dms.kjc,CloneGenerator.classes.
</p>
</li>
</ul>
</body>
</html>
